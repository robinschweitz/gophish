var teams=[],users=[];function save(e){var a=[];$.each($("#usersTable").DataTable().rows().data(),(function(e,s){var t=$("#usersTable").DataTable().row(e).node(),r=$(t).find("select#role").val();a.push({username:unescapeHtml(s[0]),id:parseInt(unescapeHtml(s[1])),role:r})}));var s={name:$("#name").val(),description:$("#description").val(),users:a};-1!==e?(s.id=e,api.teamId.put(s).success((function(e){successFlash("team updated successfully!"),load(),dismiss(),$("#modal").modal("hide")})).error((function(e){modalError(e.responseJSON.message)}))):api.teams.post(s).success((function(e){successFlash("team added successfully!"),load(),dismiss(),$("#modal").modal("hide")})).error((function(e){modalError(e.responseJSON.message)}))}function dismiss(){$("#usersTable").dataTable().DataTable().clear().draw(),$("#name").val(""),$("#modal\\.flashes").empty()}function edit(e){if(setupUserOptions(),users=$("#usersTable").dataTable({destroy:!0,columnDefs:[{orderable:!1,users:"no-sort"}]}),$("#modalSubmitTeam").unbind("click").click((function(){save(e)})),-1===e){$("#teamModalLabel").text("New team")}else $("#teamModalLabel").text("Edit team"),api.teamId.get(e).success((function(e){$("#name").val(e.name),$("#description").val(e.description),userRows=[],$.each(e.users,(function(e,a){userRows.push([escapeHtml(a.username),escapeHtml(a.id),'<select id="role" name="role_for">                        <option value="contributor"'+("contributor"==a.role.slug?"selected='selected'":"")+'>Contributor</option>                        <option value="viewer"'+("viewer"==a.role.slug?"selected='selected'":"")+'>Viewer</option>                        <option value="team_admin"'+("team_admin"==a.role.slug?"selected='selected'":"")+">Team Leader</option>                        </select>",'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'])})),users.DataTable().rows.add(userRows).draw()})).error((function(){errorFlash("Error fetching team")}))}var deleteTeam=function(e){var a=teams.find((function(a){return a.id===e}));a&&Swal.fire({title:"Are you sure?",text:"This will delete the team. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(a.name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(a,s){api.teamId.delete(e).success((function(e){a()})).error((function(e){s(e.responseJSON.message)}))}))}}).then((function(e){e.value&&Swal.fire("team Deleted!","This team has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))};function addUser(e){var a=escapeHtml(e.username).toLowerCase(),s=[escapeHtml(e.username),escapeHtml(e.id),'<select id="role" name="role_for" >        <option value="contributor">Contributor</option>        <option value="viewer" selected="selected">Viewer</option>        <option value="team_admin">Team Leader</option>        </select>','<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'];users.DataTable().column(0,{order:"index"}).data().indexOf(a)>=0?modalError("You can't assign a User twice"):users.DataTable().row.add(s)}function setupUserOptions(){if(0===users.length)return modalError("No users found!"),!1;var e=$.map(users,(function(e){return e.text=e.username,e}));$("#user.form-control").select2({placeholder:"Select User",data:e,width:"200px"})}function load(){$("#teamTable").hide(),$("#emptyMessage").hide(),$("#loading").show(),api.users.get().success((function(e){users=e})),api.teams.get().success((function(e){if($("#loading").hide(),e.length>0){teams=e,$("#emptyMessage").hide(),$("#teamTable").show();var a=$("#teamTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]});a.clear(),teamRows=[],$.each(teams,(function(e,a){teamRows.push([escapeHtml(a.name),escapeHtml(a.num_users),"<div class='pull-right'><button class='btn btn-primary' data-toggle='modal' data-backdrop='static' data-target='#team_modal' onclick='edit("+a.id+")'>                    <i class='fa fa-pencil'></i>                    </button>                    <button class='btn btn-danger' onclick='deleteTeam("+a.id+")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"])})),a.rows.add(teamRows).draw()}else $("#emptyMessage").show()})).error((function(){errorFlash("Error fetching teams")}))}$(document).ready((function(){load(),$("#userForm").submit((function(){var e=document.getElementById("userForm");if(e.checkValidity())return addUser($("#user").select2("data")[0]),users.DataTable().draw(),$("#userForm>div>input").val(""),!1;e.reportValidity()})),$("#usersTable").on("click","span>i.fa-trash-o",(function(){users.DataTable().row($(this).parents("tr")).remove().draw()})),$("#modal").on("hide.bs.modal",(function(){dismiss()}))}));