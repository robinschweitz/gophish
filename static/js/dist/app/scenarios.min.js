var scenarios=[],teams=[],item_type="scenarios";function save(e){for(var a={name:$("#name").val(),description:$("#description").val(),url:$("#url").val(),page:{id:parseInt($("#page").select2("data")[0].id)}},t=$("#template").select2("data"),n=[],o=0;o<t.length;o++)n.push({id:parseInt($("#template").select2("data")[o].id)});a.templates=n,-1!==e?(a.id=scenarios[e].id,api.scenarios.put(a).success((function(e){successFlash("Scenario edited successfully!"),load(),dismiss()})).error((function(e){modalError(e.responseJSON.message)}))):api.scenarios.post(a).success((function(e){successFlash("Scenario added successfully!"),load(),dismiss()})).error((function(e){modalError(e.responseJSON.message)}))}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#template").val("").change(),$("#page").val("").change(),$("#url").val(""),$("#users").val("").change(),$("#modal").modal("hide")}function setupScenarioOptions(){api.templates.get().success((function(e){if(0===e.length)return modalError("No templates found!"),!1;var a=$.map(e,(function(e){return e.text=e.name,e})),t=$("#template.form-control");t.select2({placeholder:"Select a Template",data:a,width:"100%"}),1===e.length&&(t.val(a[0].id),t.trigger("change.select2"))})),api.pages.get().success((function(e){if(0===e.length)return modalError("No pages found!"),!1;var a=$.map(e,(function(e){return e.text=e.name,e})),t=$("#page.form-control");t.select2({placeholder:"Select a Landing Page",data:a,width:"100%"}),1===e.length&&(t.val(a[0].id),t.trigger("change.select2"))}))}function view(e){setupScenarioOptions(),$("#modalSubmit").unbind("click").click((function(){save(e)})),$("#scenarioModalLabel").text("View Scenario"),scenario=scenarios[e],$("#name").val(scenario.name),$("#description").val(scenario.Description),$("#url").val(scenario.url);var a=scenario.templates.filter((e=>e.hasOwnProperty("id"))).map((e=>e.id.toString()));$("#template").val(a),$("#template").trigger("change.select2"),$("#page").val(scenario.page.id.toString()),$("#page").trigger("change.select2"),$("#modalSubmit").hide(),$("#name").attr("readonly",!0),$("#description").attr("readonly",!0),$("#url").attr("readonly",!0)}function edit(e){if($("#name").attr("readonly",!1),$("#description").attr("readonly",!1),$("#url").attr("readonly",!1),setupScenarioOptions(),$("#modalSubmit").unbind("click").click((function(){save(e)})),-1!==e){$("#scenarioModalLabel").text("Edit Scenario"),scenario=scenarios[e],$("#name").val(scenario.name),$("#description").val(scenario.Description),$("#url").val(scenario.url);var a=scenario.templates.filter((e=>e.hasOwnProperty("id"))).map((e=>e.id.toString()));$("#template").val(a),$("#template").trigger("change.select2"),$("#page").val(scenario.page.id.toString()),$("#page").trigger("change.select2")}else $("#scenarioModalLabel").text("New Scenario")}function copy(e){$("#modalSubmit").unbind("click").click((function(){save(-1)})),$("#name").attr("readonly",!1),$("#description").attr("readonly",!1),$("#url").attr("readonly",!1),setupScenarioOptions(),api.scenarioId.get(scenarios[e].id).success((function(e){$("#name").val("Copy of "+e.name),$("#description").val(e.Description);var a=e.templates.filter((e=>e.hasOwnProperty("id"))).map((e=>e.id.toString()));0===a.length?($("#template").val("").change(),$("#template").select2({placeholder:"Add Templates"})):($("#template").val(a),$("#template").trigger("change.select2")),e.page.hasOwnProperty("id")?($("#page").val(e.page.id.toString()),$("#page").trigger("change.select2")):($("#page").val("").change(),$("#page").select2({placeholder:campaign.page.name})),$("#url").val(e.url)})).error((function(e){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>")}))}var deleteScenario=function(e){Swal.fire({title:"Are you sure?",text:"This will delete the scenario. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(scenarios[e].name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(a,t){api.scenarios.delete(scenarios[e].id).success((function(e){a()})).error((function(e){t(e.responseJSON.message)}))})).catch((function(e){return Swal.showValidationMessage(`Request failed: ${e}`),!1}))}}).then((function(e){e.value&&Swal.fire("Scenario Deleted!","This scenario has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))};function load(){$("#scenarioTable").hide(),$("#emptyMessage").hide(),$("#loading").show(),api.scenarios.get().success((function(e){api.user.current().success((function(a){teams=a.teams,scenarios=e,$("#loading").hide(),scenarios.length>0?($("#scenarioTable").show(),scenarioTable=$("#scenarioTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),scenarioTable.clear(),scenarioRows=[],scenarios=scenarios.filter(((e,a,t)=>a===t.findIndex((a=>a.id===e.id)))),$.each(scenarios,(function(e,t){var n;n=CheckTeam(t.teams,a);var o=!1;if(a.id==t.user_id)o=!0;scenarioRows.push([escapeHtml(t.name),moment(t.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<div class='pull-right'>                                <span data-toggle='modal' data-backdrop='static' data-target='#modal'>                                "+(o||n.canEdit?"<button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Scenarios' onclick='edit("+e+")')>                                <i class='fa fa-pencil'></i>                                </button>":"<button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='View Scenarios' onclick='view("+e+")')></i>                                <i class='fa fa-eye'></i>                                </button>")+"                                </span>                                <span data-toggle='modal' data-target='#modal'>                                    <button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Scenarios' onclick='copy("+e+")'>                                        <i class='fa fa-copy'></i>                                    </button>                                </span>                                <button class='btn "+(o||n.canDelete?"btn-danger":"btn-secondary disabled")+"' data-toggle='tooltip' data-placement='left' title='"+(o||n.canDelete?"Delete Page":"You dont have permission to delete this scenario")+"' "+(o||n.canDelete?"onclick='deleteScenario("+e+")'":"disabled")+">                                    <i class='fa fa-trash-o'></i>                                </button>                                <button id='teams_button' type='button' class='btn "+(o?"btn-orange":"btn-secondary disabled")+"' data-toggle='modal' data-backdrop='static' data-target='#team_modal'"+(o?"onclick='team("+e+")'":"disabled")+"'>                                <i class='fa fa-users'></i> Update teams                                </button>                            </div>"])})),scenarioTable.rows.add(scenarioRows).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()}))})).error((function(){$("#loading").hide(),errorFlash("Error fetching scenarios")}))}function team(e){updateItemTeamsAssignment(scenarios[e],item_type,teams)}$(document).ready((function(){$(".modal").on("hidden.bs.modal",(function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy((function(e){this.$element[0]===e.target||this.$element.has(e.target).length||$(e.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")}),this))},$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),load()}));