var labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={},teams=[],item_type="campaigns";function launch(){Swal.fire({title:"Are you sure?",text:"This will schedule the campaign to be launched.",type:"question",animation:!1,showCancelButton:!0,confirmButtonText:"Launch",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(e,a){groups=[],$("#users").select2("data").forEach((function(e){groups.push({id:parseInt(e.id)})}));var t=$("#send_by_date").val();""!=t&&(t=moment(t,"MMMM Do YYYY, h:mm a").utc().format());var s=$("#start_time").val();""!=s&&(s=moment($("#start_time").val(),"h:mm a").utc().format());var n=$("#end_time").val();""!=n&&(n=moment($("#end_time").val(),"h:mm a").utc().format());for(var o=$("#scenario").select2("data"),i=[],l=0;l<o.length;l++)i.push({id:parseInt($("#scenario").select2("data")[l].id)});campaign={name:$("#name").val(),scenarios:i,smtp:{id:parseInt($("#profile").select2("data")[0].id)},launch_date:moment($("#launch_date").val(),"MMMM Do YYYY, h:mm a").utc().format(),send_by_date:t||null,groups:groups,start_time:s||null,end_time:n||null},api.campaigns.post(campaign).success((function(a){e(),campaign=a})).error((function(e){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>"),Swal.close()}))}))}}).then((function(e){e.value&&Swal.fire("Campaign Scheduled!","This campaign has been scheduled for launch!","success"),$('button:contains("OK")').on("click",(function(){window.location="/campaigns/"+campaign.id.toString()}))}))}function sendTestEmail(){for(var e=$("#scenario").select2("data"),a=0;a<e.length;a++)api.scenarioId.get(parseInt($("#scenario").select2("data")[a].id)).success((function(e){for(const t of e.templates){var a={template:{id:t.id},page:{id:e.page.id},url:e.url,first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),smtp:{id:parseInt($("#profile").select2("data")[0].id)}};btnHtml=$("#sendTestModalSubmit").html(),$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),api.send_test_email(a).success((function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-success">                        <i class="fa fa-check-circle"></i> Email Sent!</div>'),$("#sendTestModalSubmit").html(btnHtml)})).error((function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">                        <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>"),$("#sendTestModalSubmit").html(btnHtml)}))}})).error((function(e){btnHtml=$("#sendTestModalSubmit").html(),$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> Please set the scenarios</div>'),$("#sendTestModalSubmit").html(btnHtml)}))}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#profile").val("").change(),$("#users").val("").change(),$("#modal").modal("hide")}function deleteCampaign(e){Swal.fire({title:"Are you sure?",text:"This will delete the campaign. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(campaigns[e].name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(a,t){api.campaignId.delete(campaigns[e].id).success((function(e){a()})).error((function(e){t(e.responseJSON.message)}))})).catch((function(e){return Swal.showValidationMessage(`Request failed: ${e}`),!1}))}}).then((function(e){e.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))}function setupOptions(){api.scenarios.get().success((function(e){if(0===e.length)return modalError("No scenarios found!"),!1;var a=$.map(e,(function(e){return e.text=e.name,e})),t=$("#scenario.form-control");t.select2({placeholder:"Select the Scenarios",data:a}).select2("val",a[0]),1===e.length&&(t.val(t[0].id),t.trigger("change.select2"))})),api.groups.summary().success((function(e){if(groups=e.groups,0==groups.length)return modalError("No groups found!"),!1;var a=$.map(groups,(function(e){return e.text=e.name,e.title=e.num_targets+" targets",e}));console.log(a),$("#users.form-control").select2({placeholder:"Select Groups",data:a})})),api.SMTP.get().success((function(e){if(0==e.length)return modalError("No profiles found!"),!1;var a=$.map(e,(function(e){return e.text=e.name,e})),t=$("#profile.form-control");t.select2({placeholder:"Select a Sending Profile",data:a}).select2("val",a[0]),1===e.length&&(t.val(a[0].id),t.trigger("change.select2"))}))}function edit(e){setupOptions()}function copy(e){setupOptions(),api.campaignId.get(campaigns[e].id).success((function(e){$("#name").val("Copy of "+e.name);var a=[];console.log(e.scenarios);for(var t=0,s=e.scenarios.length;t<s;t++)e.scenarios[t].hasOwnProperty("id")&&a.push(e.scenarios[t].id.toString());0===a.length?($("#scenario").val("").change(),$("#scenario").select2({placeholder:"Add Scenarios"})):($("#scenario").val(a),$("#scenario").trigger("change.select2")),e.smtp.id?($("#profile").val(e.smtp.id.toString()),$("#profile").trigger("change.select2")):($("#profile").val("").change(),$("#profile").select2({placeholder:e.smtp.name}))})).error((function(e){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>")}))}function team(e){updateItemTeamsAssignment(campaigns[e],item_type,teams)}$(document).ready((function(){$("#launch_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,defaultDate:moment(),format:"MMMM Do YYYY"}),$("#send_by_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,useCurrent:!1,format:"MMMM Do YYYY"}),$("#start_time").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!1,defaultDate:!1,format:"h:mm a"}),$("#end_time").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!1,defaultDate:!1,format:"h:mm a"}),document.getElementById("special_time_checkbox").checked||($(".toggle-label-time").hide(),$("#start_time").hide(),$("#end_time").hide()),document.getElementById("special_sending_checkbox").checked&&($(".toggle-label").hide(),$("#send_by_date").hide()),$("#special_time_checkbox").change((function(){document.getElementById("special_time_checkbox").checked?($(".toggle-label-time").show(),$("#start_time").show(),$("#end_time").show()):($(".toggle-label-time").hide(),$("#start_time").hide(),$("#end_time").hide(),$("#start_time").data("DateTimePicker").date(null),$("#end_time").data("DateTimePicker").date(null))})),$("#special_sending_checkbox").change((function(){document.getElementById("special_sending_checkbox").checked?($(".toggle-label").hide(),$("#send_by_date").hide(),$("#launch_date").datetimepicker().data("DateTimePicker").format("MMMM Do YYYY, h:mm a"),$("#send_by_date").data("DateTimePicker").date(null)):($(".toggle-label").show(),$("#send_by_date").show(),$("#launch_date").datetimepicker().data("DateTimePicker").format("MMMM Do YYYY"),$("#send_by_date").datetimepicker().data("DateTimePicker").format("MMMM Do YYYY"))})),$(".modal").on("hidden.bs.modal",(function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),api.campaigns.summary().success((function(e){api.user.current().success((function(a){teams=a.teams,items=e.campaigns,campaigns=e.campaigns,$("#loading").hide(),campaigns.length>0?($("#campaignTable").show(),$("#campaignTableArchive").show(),activeCampaignsTable=$("#campaignTable").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[1,"desc"]]}),archivedCampaignsTable=$("#campaignTableArchive").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[1,"desc"]]}),rows={active:[],archived:[]},campaigns=campaigns.filter(((e,a,t)=>a===t.findIndex((a=>a.id===e.id)))),$.each(campaigns,(function(e,t){const[s,n]=CheckTeam(t.teams,a);var o=!1;if(a.id==t.user_id)o=!0;if(label=labels[t.status]||"label-default",moment(t.launch_date).isAfter(moment()))var i="Scheduled to start: "+moment(t.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+t.stats.total;else i="Launch Date: "+moment(t.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+t.stats.total+"<br><br>Emails opened: "+t.stats.opened+"<br><br>Emails clicked: "+t.stats.clicked+"<br><br>Submitted Credentials: "+t.stats.submitted_data+"<br><br>Errors : "+t.stats.error+"<br><br>Reported : "+t.stats.email_reported;var l=[escapeHtml(t.name),moment(t.created_date).format("MMMM Do YYYY, h:mm:ss a"),'<span class="label '+label+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+i+'">'+t.status+"</span>","<div class='pull-right'><a class='btn btn-primary' href='/campaigns/"+t.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>                    <i class='fa fa-bar-chart'></i>                    </a>            <span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Campaign' onclick='copy("+e+")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn "+(o||s?"btn-danger":"btn-secondary disabled")+"' data-toggle='tooltip' data-placement='left' title='"+(o||s?"Delete Campaign":"You dont have permission to delete this campaign")+"' "+(o||s?"onclick='deleteCampaign("+e+")'":"disabled")+">                    <i class='fa fa-trash-o'></i>                    </button>                    <button id='teams_button' type='button' class='btn "+(o?"btn-orange":"btn-secondary disabled")+"' data-toggle='modal' data-backdrop='static' data-target='#team_modal'"+(o?"onclick='team("+e+")'":"disabled")+"'>                    <i class='fa fa-users'></i> Update teams                    </button></div>"];"Completed"==t.status?rows.archived.push(l):rows.active.push(l)})),activeCampaignsTable.rows.add(rows.active).draw(),archivedCampaignsTable.rows.add(rows.archived).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()}))})).error((function(){$("#loading").hide(),errorFlash("Error fetching campaigns")})),$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("dropdownParent",$("#modal_body")),$.fn.select2.defaults.set("theme","bootstrap"),$.fn.select2.defaults.set("sorter",(function(e){return e.sort((function(e,a){return e.text.toLowerCase()>a.text.toLowerCase()?1:e.text.toLowerCase()<a.text.toLowerCase()?-1:0}))}))}));